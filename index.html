<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA Compatible" content="IE=edge,chrome=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	
	<link rel="shortcut icon" href="favicon.png">
	<link rel="apple-touch-icon-precomposed" href="icon.png">
	<link rel="apple-touch-startup-image" href="splash.png">
	
    <link rel="stylesheet" href="css/claro.css">
    <link rel="stylesheet" href="css/esri.css">
	<link rel="stylesheet" href="css/jquery-ui.css" />
	<link rel="stylesheet" href="css/jquery.mobile.css" />
	<link rel="stylesheet" href="css/geokip.css" />
	
	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.3.2.min.js"></script>
    <script type="text/javascript" src="http://js.arcgis.com/3.6compact/"></script>
	<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	<script src="js/geokip.js" type="text/javascript"></script>
	<script src="phonegap.js"></script>
	
	
	<style type="text/css">
        html,body, div[data-role ="page"] {
			height: 100%;
			width: 100%;
			margin: 0px;
			padding: 0px;
        }
		@media print {
		  html, body {
			height: auto;
		  }

		  #map-canvas, #map_canvas {
			height: 650px;
		  }
		}

		#map-canvas, #map_canvas {
		  height: 100%;
		}
		#panel {
		  position: absolute;
		  top: 5px;
		  left: 50%;
		  margin-left: -180px;
		  z-index: 5;
		  background-color: #fff;
		  padding: 5px;
		  border: 1px solid #999;
		}
        .conten{
            height: 100%;
            width: 100%;
            margin: 0px;
            padding: 0px;
        }
		div h4{
			color:#fff;
		}
        #map {
            position: absolute;
            background-color: #EEEEDD;
            height: 100%;
            width: 100%;
            padding: 0px;
            z-index: 0;
        
        }
        
        #div1{
            position:absolute;
            margin: 5px;
            /*top: 0px;*/
            z-index:1;
        }
        #geo-indicator{
            color: LightSeaGreen;
        }
        #table1{
            color: #FFFFFF;
            font-family: Arial, Helvetica, sans-serif;
            background-color: #000000;
            opacity: 0.6;
        
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
        }
		.modalmapsearch a img {
		  border: none;
		}
		.modalmapsearch .marker-image {
		  float: left;
		  margin-right: 0.5em;
		}
		.modalmapsearch .result {
		  margin-bottom: 1em;
		  float: left;
		  clear: both;
		  width: 100%;
		  display: block;
		}
		.modalmapsearch .searchform {
		  margin-bottom: 0.5em;
		}
		.modalmapsearch .paginator {
		  position: absolute;
		  bottom: 1em;
		  right: 40%;
		  display: inline;
		}
    </style>
</head>
<body class="index" onload="getStorageQty()">

	<div data role="page" id="pre">
	
	
	
	</div>
	<div data-role="page" id="home">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" class="ui-state-persist">Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" data-iconpos="notext">Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide" data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
		<div id="div1">
			<table id="table1" border="1">
				<tr>
					<td>
						<div  style="color:#ff4160">Lat, Long</div>
					</td>
					<td colspan="2">
						<div id="location">0.00, 0.00</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="color:#ff4160">Speed</div>
					</td>
					<td>
						<div id="speed">Unknown</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="color:#ff4160">Accuracy:</div>
					</td>
					<td>
						<div id="accuracy"> 0m</div>
					</td>
				</tr>

			</table>
		</div>

		<div data-role="content" class="conten">
			<div id="map"></div>
		</div>
	</div>
	
	<div data-role="page" id="loc_mgmt">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" >Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" >Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide" class="ui-state-persist" data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
		<div data-role="content" id="content">
			<ul data-role="listview" id="locationItems"  data-filter="true" data-filter-placeholder="Search saved Places..." data-autodividers="true" data-inset="true" data-theme="c" data-dividertheme="a">
				<br>
				<li data-role="list-divider" data-theme="c"  data-role="list-divider" class="itemsTitle" id="Landmarks">Landmarks</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="art">Resturants</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Hospital">Hospital</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="entertainment">Entertainment</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Security">Security</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Education">Education</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Church">Church</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Mosque">Mosque</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Shrine">Shrine</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="landscape">Landscape & View</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Sports">Sports</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="Party">Party</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="professional">Professional</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="shopping">Shopping</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="techonology">Technology</li>
				<li data-role="list-divider" data-theme="c" data-role="list-divider" class="itemsTitle" id="other">Other</li>
			</ul>
			<div id="geoMessage"></div>
			<div data-type="horizontal" data-role="controlgroup">
				<a data-icon="arrow-u" title="Scroll back to Top" data-role="button">Top of page</a>&nbsp;
				<a href="#clear" data-icon="delete" title="Delete all entries" data-role="button">Clear all</a>
			</div>
		</div>
	</div>
	
	<div data-role="page" id="clear">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" >Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" >Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide" class="ui-state-persist" data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
		<div data-role="content">
		<h3>Clear All Data</h3>
			<p>Are you sure you want to delete all items?<br>This action can not be undone.</p>
			<div data-type="horizontal" data-role="controlgroup">
				<a href="#home" onclick="deleteAll()" title="Clear Records" data-icon="check" data-role="button">Yes</a>&nbsp;
				<a href="#loc_mgmt" title="Cancel Deletion" data-icon="delete" data-role="button">Cancel</a>
			</div>
		</div>
	</div>
	
	<div data-role="page" id="add">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" >Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide"  class="ui-state-persist" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" >Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide"data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
			<div data-role="content" id="geo_content">
			<label for="nameInput">Name this place:</label>
			<input type="text" name="nameInput" placeholder="Type a name for this place..." id="nameInput">
			<label for="selectType">Location type:</label>
			<select name="selectType" id="selectType">
				<option value="Landmarks">Landmarks</option>
				<option value="art">Resturants</option>
				<option value="Hospital">Hospital</option>
				<option value="entertainment">Entertainment</option>
				<option value="Security">Security</option>
				<option value="Education">Education</option>
				<option value="Church">Church</option>
				<option value="landscape">Landscape & View</option>
				<option value="Sports">Sports</option>
				<option value="party">Party</option>
				<option value="professional">Professional</option>
				<option value="shopping">Shopping</option>
				<option value="technology">Technology</option>
				<option value="other">Other</option>
			</select>
			<input type="hidden" name="coordinates" id="coordinates">
			<input type="hidden" name="itemId"  id="itemId">
			<div id="mapImage"></div>
			<div data-role="button" id="geoButton" data-theme="a" onclick="getGeo()">Show map</div>
			<div data-role="controlgroup" id="clearSaveButtons" style="display:none;" data-type="horizontal">
				<div data-role="button" id="saveButton" data-theme="b" onclick="saveItem()" data-icon="check">Save Item</div>&nbsp;
				<div data-role="button" id="clearButton" data-theme="c" onclick="clearItem()" data-icon="back">Clear Form</div>
			</div>
		</div>
	</div>

	<div data-role="page" id="itemView">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" >Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide"  class="ui-state-persist" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" >Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide"data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
		<div data-role="content" id="itemContent">			<ul data-role="listview" data-theme="c" data-dividertheme="a">
				<li data-role="list-divider" id="itemListType">Type</li>
				<li data-role="list-divider" id="itemListName">Name</li>
			</ul>
			<div id="itemListMap"></div>
			<div>
				<a href="#delItem" data-icon="delete" data-role="button">Delete Item</a>
			</div>
			<input type="hidden" name="itemKey" id="itemKey">
		</div>
	</div>

	<div data-role="page" id="delItem">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#info" data-role="button" data-icon="info" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-left">About</a>
			<a href="#howto" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">Help</a>
			</h4>
			<!--Nav Bar -->
			<div data-role="navbar" data-iconpos="left">
				<ul>
					<li ><a  href="#home" onclick="currentLoc()" data-icon="home" title="View location" title="Find the Location your are at right now" >Home</a></li>
					<li ><a href="#add" href="#add" data-icon="html5-offline" onclick="currentLoc()" title="Track your current Location" data-transition="slide"  class="ui-state-persist" >Track</a></li>
					<li ><a href="#locat" data-transition="slide"  data-icon="search" >Search</a></li>
					<li ><a href="#loc_mgmt" data-transition="slide"data-icon="grid">Places <sup class="ui-li-count" style="font-size:0.6em; color:#ff6140" id="storageQty"></sup></a></li>
				</ul>
			</div>
			<!-- /navbar -->
		</div>
		<div data-role="content">
		<p>Are you sure you want to delete the item <span id="item2Del"></span>?</p>
			<div data-role="controlgroup" data-type="horizontal">
				<a href="#home" onclick="deleteItem()" title="Clear Item" data-icon="check" data-role="button">Yes</a>&nbsp;
				<a href="#itemView" title="Cancel Deletion" data-icon="delete" data-role="button">Cancel</a>
			</div>
			<input id="itemKey2Del" type="hidden">
		</div>
	</div>
	
	<div data-role="page" id="locat" data-overlay-theme="a" data-theme="a" data-corners="false" data-tolerance="15,15">

		<iframe src="local.html" width="100%" height="100%" seamless frameborder="0" scrolling="no"></iframe>
		 
	</div>


	<div data-role="page" id="howto">
		<div data-role="header"  data-position="fixed" style="overflow:hidden;">
			<h4 style="font-style:bold;">GeoKip&trade; 
			<a href="#" data-role="button" data-icon="back" data-iconpos="notext" data-rel="back" data-transition="slideup" class="ui-btn-left">Back</a>
			<a href="#info" data-role="button" data-icon="alert" data-iconpos="notext" data-transition="slidedown"  data-rel="dialog"  class="ui-btn-right">About</a>
			</h4>
		</div>
		<div data-role="content">
			<h2>Hello,</h2>
			<p>First of all I want to thank you for using this app. A lot of curiosity and work has gone in this project and I am really grateful for people like you that load and use it.</p>
			<p>Now, to go to the point, let me tell you that this is a very easy and straightforward utility to operate. The main menu is divided in the three main functions of the app:</p>
			<ul>
				<li>Add a new Locattion</li>
				<li>Manage saved Places</li>
				<li>Get Directions</li>
			</ul>
			<p>The first function, -Add a new location-, is strictly what it means. It is also your Home screen by default, with two inputs and a button. The first input is labeled as name and can be named whatever you want. You can type in a brief descriptions or simply a two / three words name for the item. The second input is a drop down menu that offers a general category for the item. Finally, the button collects your current Geographical Position via your GPS, Cell Tower Triangulation or IP Address, whichever is available and in that order.</p>
			<p>Once you tap/click the button and you've given permission to give the app access to your geoLocation devices, a map image will appear with your geographical position marked. If that is right (which more or less will be) simply tap/click on the -Save item- button and your item will be saved locally in your phone.</p>
			<p>The second function of the app, -Manage saved places-, reviews your phone's storage for this app in particular and looks for items of previously saved places, all listed by category. Once you see an item you want to review, simply tap/click on it and you will be shown all the information for that item: name, category and map image. In that same review screen you are given the option to delete the item.</p>
			<p>Third Function -Get Directions- Allows you to search for locations around yound include driving, walking and flying directions to such place</p>
			<p>Am currently working on a module that allows for remote check on your location</p>
			<p>That's pretty much all this app does. Even though it doesn't seem like much, I've learnt that, in the mobile development/design world, the rule of thumb is "less is more". I hope you enjoy this piece of code and invite you to review the -Info- page to see all the details, person and plans behind this project.</p>
			<p>Best regards,</p>
			<p>Ojengwa Bernard<br> facebook.com/ojengwa</p>
			<h4><span style="color:#ff6140">&copy; Syscomptech Ltd.</span><br><em style="font-size:0.5em; font-style:italics">www.syscomptech.ng</em></h4>
		</div>
	</div>
	
	<div data-role="page" id="info">
		<div data-role="content">
			<div data-role="header" data-position="fixed" style="overflow:hidden;">
				<h4 style="font-style:bold;"><a href="#" data-role="button" data-icon="back" data-iconpos="notext" data-rel="back" data-transition="slideup" class="ui-btn-left">Back</a> About GeoKip&trade;</h4>
			</div>
			<!--Main Content area -->
			<div data-role="content">
			<p>This is free Software from Syscomptech Nigeria Ltd.<br>Contact the designer on<br>Facebook: ojengwa Bernard<br>Enjoy!!</p>
			</div>
			<!--/Main Content area -->
			<!--Footer-->
			<div data-role="footer" data-id="footer" data-position="fixed" data-theme='a' style="overflow:hidden;">
				<p style="font-size:0.7em; text-align:center;" data-theme='e'>&copy; <script rel='javascript'>var g = new Date(); document.write(g.getFullYear());</script>, <a href="#sys" style="text-decoration:none; color:#ff6140;" data-rel="dialog">Syscomptech LTD.</a></p>
			</div>
			<!-- /footer -->
		</div>
	</div>
	
	

<script type="text/javascript">

    $('document').ready(function(){
        $("#slider-geo-on-off").on("slidestop",controller.shutOffGeolocation);
        $("#slider-high-accuracy").on("slidestop",controller.toggleHighAccuracy);
        $("#slider-accumulate-pts").on("slidestop",controller.toggleAccumulate);
        $("#slider-handle-err").on("slidestop",controller.toggleErrorAlerts)
    })
    
    //set deviceReady flag if phonegap is ready
    $('document').ready( function(){controller.deviceReady = true});

    /**
     * View Controller
     * @type {Object}
     */
    var controller = controller || {};

    /////
    // PUBLIC Variables
    /////

    controller.map = null;
    controller.helper = null;
    controller.deviceReady = false;
    controller.utils = {};

    /**
     * A property indicating a reference to the current view.
     * Default = null
     * @type {String}
     */
    controller.viewChange = null;
    /**
     * Allows points to accumulate on map. Default is true.
     * @type {boolean}
     */
    controller.accumulate = true;
    /**
     * Geolocation timeout property for watchPosition
     * Default = 60000
     * @type {number}
     */
    controller.timeout = 1000;
    /**
     * Geolocation maximumAge property for watchPosition
     * Default = 60000
     * @type {number}
     */
    controller.maximumAge = 5000;
    /**
     * Geolocation timeout property for currentPosition
     * Default = 60000
     * @type {number}
     */
    controller.timeoutCurrentPos = 10000;
    /**
     * Geolocation maximumAge property for currentPosition.
     * Default = 60000
     * @type {number}
     */
    controller.maxAgeCurrentPos = 60000;
    /**
     * Sets the map zoom level. Default = 14;
     * @type {int}
     */
    controller.zoomLevel = 14;
    /**
     * If set to false then alerts will be silent and errors written to the console.
     * @type {boolean}
     */
    controller.useAlerts = false;
    /**
     * A reference to the Geolocation On/Off slider
     * @type {slider}
     */
    controller.geoSliderOnOff = null;

    /**
     * Local Storage ENUMs
     * @type {Object}
     */
    controller.localStorageEnum = (function(){
        var values = {
            ZOOM_LEVEL:"zoom_level",
            LAT:"lat",
            LON:"lon",
            MAP_WIDTH:"map_width",
            MAP_HEIGHT:"map_height",
            PORTRAIT:"portrait",
            LANDSCAPE:"landscape"
        }

        return values;
    });

    /**
     * Does browser support localStorage?
     * Always validate HTML5 functionality :-)
     */
    (function (){
        var support = null;
        try {
            support = 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
            support = false;
        }
        controller._supportsLocalStorage = support;
    }).bind(this)();

    controller.init = (function() {

        controller.map = new esri.Map("map",{
            basemap: "topo",
            center: [-98.6, 39.8],
            slider: true,
            zoom: 2
        });

        controller.map.addLayer(controller._locatorMarkerGraphicsLayer);

        //Listen for map zoom end events
        controller._on(controller.map, "zoom-end", function (extent,zoom,anchor,level){
            controller.zoomLevel = level;
        })

        //Listen for when the map loads
        controller._on(controller.map,"load", function () {

            //Adjust the map's zoom slider
            var zoom_slider_left = parseFloat($('#map_zoom_slider').css('left'));
            var zoom_slider_width = parseFloat($('#map_zoom_slider').css('width'));
            $('#div1').css('left',zoom_slider_left * 2 + zoom_slider_width + "px");


            //Some browsers don't show full height after onLoad
            controller.map.reposition();
            controller.map.resize();

            if(controller.deviceReady == true){
                controller.startGeolocation();
            }
            else{
                console.log("Device not ready - unable to start geolocation.");

            }

            //Handle orientation events to allow for resizing the map and working around
            //jQuery mobile bugs related to how and when the view settles after such an event
            var supportsOrientationChange = "onorientationchange" in window,
                    orientationEvent = supportsOrientationChange ? "orientationchange" : "resize";

            window.addEventListener(orientationEvent, function () {
                controller.rotateScreen(400,true);
            }, false);

            //Fix bug in jQuery that destroys map when child view is rotated
            $("div:jqmData(role='page')").on('pagehide',function(){
                controller.viewChange = this.id;
                console.log('view changed ' + controller.map.height + ", " + controller.map.width);
                controller.rotateScreen(400,true);
            });

        });
    });

    /**
     * Not currently used
     * @type {Function}
     */
    controller.timeoutCurrentPoschange = (function(){
        controller.timeoutCurrentPos = $("#timeout-current-pos").val();
        console.log(controller.timeoutCurrentPos);
    });

    controller.restartGeo = (function restartGeo(){
        var test = confirm("Restart Geolocation?");
        if(test){
            var maxAgeCurrentPos = $("#max-age-current-pos").val();
            var timeoutCurrentPos = $("#timeout-current-pos").val();
            var maxAge = $("#max-age-watch-pos").val();
            var timeout = $("#timeout-watch-pos").val();
            if(controller.isNumber(maxAgeCurrentPos) && controller.isNumber(timeoutCurrentPos) &&
                controller.isNumber(maxAge) && controller.isNumber(timeout)){
                    controller.maxAgeCurrentPos = maxAgeCurrentPos;
                    controller.timeoutCurrentPos = timeoutCurrentPos;
                    controller.timeout = timeout;
                    controller.maximumAge = maxAge;
                    controller.startGeolocation();
            }
            else{
                alert("Check all your inputs they must be numeric.")
            }
        }
    });

    controller.toggleAccumulate = (function(evt){
        if(evt.target.id == "slider-accumulate-pts" && evt.target.value == "on"){
            controller.accumulate = true;
        }
        else{
            controller.accumulate = false;
        }
    });

    controller.isNumber = (function(value){
        return !isNaN(parseFloat(value)) && isFinite(value);
    });

    controller.showLocation = (function(){
        if($('#div1').is(':visible') == false || $('#div1').is(':hidden')){
            $('#div1').show();
        }
        else{
            $('#div1').hide();
        }

    });

    /**
     * Public function for shutting down the geolocation service.
     */
    controller.shutOffGeolocation = (function(evt){

        if(evt.target.id == "slider-geo-on-off" && evt.target.value == "on"){
            controller.restartGeo();
        }
        else{
            controller.stopGeolocation();
            alert("Geolocation has been shutoff");
        }
    });

    /**
     * Public function for toggling the geolocation high-accuracy property on/off
     */
    controller.toggleHighAccuracy = (function(evt){

        if(evt.target.id == "slider-high-accuracy" && evt.target.value == "on"){
            controller.setHighAccuracy(true);
        }
        else{
            controller.setHighAccuracy(false);
        }

    });

    controller.toggleErrorAlerts = (function(evt){
        if(evt.target.id == "slider-handle-errs" && evt.target.value == "on"){
            controller.useAlerts = true;
        }
        else{
            controller.useAlerts = false;
        }
    });

    /**
     * Turns on the geolocation capabilities.
     */
    controller.startGeolocation = function(){

        var _dateStart = new Date();
        var _previousDate = null;

        if(controller._supportsLocalStorage){
            try{
                localStorage.setItem(controller.localStorageEnum().MAP_WIDTH,$("#map").width());
                localStorage.setItem(controller.localStorageEnum().MAP_HEIGHT,$("#map").height());
                window.innerHeight > window.innerWidth ?
                        controller._orientation = controller.localStorageEnum().PORTRAIT :
                        controller._orientation = controller.localStorageEnum().LANDSCAPE;
            }
            catch(err){
                console.log("_supportsLocationStorage: " + err.message);
            }
        }

        try{
            if (navigator.geolocation) {
                console.log("setHighAccuracy = " + controller._setHighAccuracy);

                navigator.geolocation.getCurrentPosition(
                        _processGeolocationResult.bind(this)/* use bind() to maintain scope */,
                        _html5Error.bind(this),
                        {
                            maximumAge: controller.maxAgeCurrentPos,
                            timeout: controller.timeoutCurrentPos,
                            enableHighAccuracy: controller._setHighAccuracy
                        }
                );

                controller._watchID = navigator.geolocation.watchPosition(
                        _processGeolocationResult.bind(this),
                        _html5Error.bind(this),
                        {
                            timeout: controller.timeout,
                            enableHighAccuracy: controller._setHighAccuracy,
                            maximumAge: controller.maximumAge
                        }
                );

                //For more info on maximumAge (milliseconds): http://dev.w3.org/geo/api/spec-source.html#max-age
                //For more info on timeout (milliseconds): http://dev.w3.org/geo/api/spec-source.html#timeout
                //For more info on enableHighAccuracy: http://dev.w3.org/geo/api/spec-source.html#high-accuracy
            }
            else {
                alert("Sorry, your browser does not support geolocation");
            }
        }
        catch(err){
            alert("Unable to start geolocation. See console.log for message.")
            console.log("startGeolocation: " + err.message);
        }

        /**
         * Post-process the results from a geolocation position object.
         * @param position
         * @private
         */
        function _processGeolocationResult(position) {

            var html5Lat = position.coords.latitude; //Get latitude
            var html5Lon = position.coords.longitude; //Get longitude
            var html5TimeStamp = position.timestamp; //Get timestamp
            var html5Accuracy = position.coords.accuracy; 	//Get accuracy in meters
            var html5Heading = position.coords.heading;
            var html5Speed = position.coords.speed;
            var html5Altitude = position.coords.altitude;

            console.log("success " + html5Lat + ", " + html5Lon);
            $("#geo-indicator").text("Geo: ON");
            $("#geo-indicator").css('color','green');

            controller._displayGeocodedLocation(position);

            if (position.coords.latitude != null && position.coords.longitude != null) {
                //zoomToLocation(html5Lat, html5Lon);

                //Don't allow string to get beyond certain length.
                //Otherwise you'll create a huge memory leak. :-)
                if(controller._accuracyDataCSV.length < 50000){

                    var newDateDiff = null;
                    var ms = null;
                    var dateNow = new Date();
                    var totalElapsedTime =  _getTimeDifference(new Date(Math.abs(dateNow.getTime() - _dateStart.getTime())));

                    _previousDate == null ?
                            newDateDiff = new Date(Math.abs(dateNow.getTime() - _dateStart.getTime())) :
                            newDateDiff = new Date(Math.abs(dateNow.getTime() - _previousDate.getTime()));

                    _previousDate = new Date();

                    var dateResultString = _getTimeDifference(newDateDiff);

                    controller._accuracyDataCSV = controller._accuracyDataCSV + Date(html5TimeStamp).toLocaleString() +
                            "," + html5Lat +
                            "," + html5Lon +
                            "," + html5Accuracy +
                            "," + controller._setHighAccuracy +
                            "," + html5Altitude +
                            "," + html5Heading +
                            "," + html5Speed +
                            "," + position.coords.altitudeAccuracy +
                            "," + dateResultString +
                            "," + totalElapsedTime +
                            ",\r\n";
                }
                else{
                    console.log("Truncating CSV string. It is too long");
                }

                if(html5Lat != 0){
                    //var wgsPt = new esri.geometry.Point(html5Lon,html5Lat);
                    controller._mostRecentLocation =  new esri.geometry.Point(html5Lon,html5Lat);
                    //this._map.centerAndZoom(this._mostRecentLocation, 14);
                    controller._showLocation(html5Lat,html5Lon,controller._mostRecentLocation);

                    if(controller._supportsLocalStorage){
                        localStorage.setItem(controller.localStorageEnum().LAT,html5Lat);
                        localStorage.setItem(controller.localStorageEnum().LON,html5Lon);
                        localStorage.setItem(controller.localStorageEnum().ZOOM_LEVEL,controller.map.getZoom());
                    }
                    console.log('false, ' +
                            localStorage.getItem(controller.localStorageEnum().MAP_WIDTH) + ", " +
                            localStorage.getItem(controller.localStorageEnum().MAP_HEIGHT) + ", " +
                            localStorage.getItem(controller.localStorageEnum().ZOOM_LEVEL) + ", " +
                            this.map.getZoom()
                    );
                }
            }
        }

        /**
         * Calculate HH:MM:SS:MS from a given Date in millis
         * @param date
         * @returns {string}
         * @private
         */
        function _getTimeDifference(/* Date */ date){;
            var msec = date;
            var hh = Math.floor(msec / 1000 / 60 / 60);
            msec -= hh * 1000 * 60 * 60;
            var mm = Math.floor(msec / 1000 / 60);
            msec -= mm * 1000 * 60;
            var ss = Math.floor(msec / 1000);
            msec -= ss * 1000;

            hh = hh < 10 ? "0" + hh : hh;
            mm = mm < 10 ? "0" + mm : mm;
            ss = ss < 10 ? "0" + ss : ss;
            msec = msec < 10 ? "0" + msec : msec;

            console.log("time: " + hh + ":" + mm + ":" + ss + ":" + msec);

            return hh + ":" + mm + ":" + ss + ":" + msec;
        }

        /**
         * Handle geolocation service errors
         * @param error
         * @private
         */
        function _html5Error(error) {
            var error_value = "null";

            switch(error.code){
                case 1:
                    error_value = "PERMISSION_DENIED";
                    this.geoSliderOnOff.val("off");
                    break;
                case 2:
                    error_value = "POSITION_UNAVAILABLE";
                    break;
                case 3:
                    //Read more at http://dev.w3.org/geo/api/spec-source.html#timeout
                    error_value = "TIMEOUT";
                    break;
            }

            controller.useAlerts == true ?
                    alert('There was a problem retrieving your location: ' + error_value) :
                    console.log('There was a problem retrieving your location: ' + error_value);
        }

    }

    /**
     * Write geolocation values to UX
     * @param position
     * @private
     */
    controller._displayGeocodedLocation = function(position) {
        var altitude = "n/a";
        if(position.coords.altitude != null) altitude = position.coords.altitude.toFixed(2) + "m";
        var speed = "n/a";
        if (position.coords.speed != null) (position.coords.speed * 3600 / 1000).toFixed(2) + "km/hr";
        var heading = "n/a";
        if (position.coords.heading != null) position.coords.heading.toFixed(2) + "deg";

        $("#location").text(position.coords.latitude.toFixed(4) + ", " + position.coords.longitude.toFixed(4));
        $("#altitude").text("Alt: " + altitude);
        $("#speed").text(speed);
        $("#heading").text("Hdg: " + heading);

        //Tested on desktop IE9, Chrome 17, Firefox 10, Safari ?
        //Mobile browser: Android 2.3.6
        //There is a bug in Safari browsers on Mac that shows the year as 1981
        //To get around the bug you could manually parse and then format the date. I chose not to for this demo.
        var date = new Date(position.timestamp)
        $("#timestamp").text(date.toLocaleString());
        $("#accuracy").text(position.coords.accuracy.toFixed(2) + "m");

    }

    controller._showLocation = function(/* number */myLat,/* number */myLong,/* esri.geometry.Geometry */geometry) {

        var myPositionSymbol = null;
        var locatorSymbol = null;

        if(window.devicePixelRatio >= 2){
            myPositionSymbol = controller._pushPinLarge;
            locatorSymbol = controller._locatorMarkerLarge;
        }
        else{
            myPositionSymbol = controller._pushPinSmall;
            locatorSymbol = controller._locatorMarkerSmall;
        }

        //    map.infoWindow.setTitle("HTML5 Location");
        //    map.infoWindow.setContent('Lat : ' + myLat.toFixed(4) + ", " + ' Long: ' + myLong.toFixed(4));
        //    map.infoWindow.resize(200,65);
        //    map.infoWindow.show(mapPoint, esri.dijit.InfoWindow.ANCHOR_LOWERLEFT);

        controller.map.graphics.clear();
        controller.map.graphics.add(new esri.Graphic(geometry, myPositionSymbol));
        controller.map.centerAndZoom(geometry, controller.zoomLevel);

        if(controller.accumulate == true)controller._locatorMarkerGraphicsLayer.add(new esri.Graphic(geometry, locatorSymbol));

    }

    /**
     * Executes a clearWatch() to cease all watchPosition() activity.
     */
    controller.stopGeolocation = (function(){
        try{
            navigator.geolocation.clearWatch(controller._watchID);
            controller._watchID = null;
            $("#geo-indicator").text("Geo: OFF");
            $("#geo-indicator").css('color','red');
        }
        catch(err){
            console.log("stopGeolocation error: " + err.toString());
        }
    });

    /**
     * RECOMMENDATION FOR PHONEGAP - set property in manifest to prevent screen rotation!
     * Repositions the map after a screen rotation. Note there are bugs in jQuery
     * related to screen rotation when you are in a child view.
     * These bugs can affect the map and its associated properties.
     * @param value Timer delay property in ms
     * @param useLocalStore boolean sets whether or not to use localStorage values to recenter map.
     */
    controller.rotateScreen = (function(value,/* boolean */ useLocalStore){
        if(typeof useLocalStore == 'undefined') useLocalStore = false;

        console.log('rotateScreen, ' +
                localStorage.getItem(controller.localStorageEnum().MAP_WIDTH) + ", " +
                localStorage.getItem(controller.localStorageEnum().MAP_HEIGHT) + ", " +
                localStorage.getItem(controller.localStorageEnum().ZOOM_LEVEL));

        try{
            if(controller.viewChange == null || controller.viewChange == "settings"){

                var timeout = null;
                value != "undefined" ? timeout = value : timeout = 500;
                setTimeout((function(){
                    if(controller.map != null && controller._mostRecentLocation != null){

                        //NOTE: This attempts to fix a bug in jQuery where rotating
                        //device from a child window resets map div values and other map properties.
                        //TO-DO Still needs some tweaking -- not perfect.
                        if(controller.map.height == 0 || controller.map.width == 0){
                            if(useLocalStore == false){
                                if(controller._orientation == controller.localStorageEnum().PORTRAIT)
                                {
                                    controller.map.width = localStorage.getItem(controller.localStorageEnum().MAP_WIDTH);
                                    controller.map.height = localStorage.getItem(controller.localStorageEnum().MAP_HEIGHT);
                                }
                                else{
                                    controller.map.width = localStorage.getItem(controller.localStorageEnum().MAP_HEIGHT);
                                    controller.map.height = localStorage.getItem(controller.localStorageEnum().MAP_WIDTH);
                                }

                                controller.map.resize();
                                controller.map.reposition();
                                //map.width = screen.width;

                                var wgsPt = new esri.geometry.Point(
                                        localStorage.getItem(controller.localStorageEnum().LON),
                                        localStorage.getItem(controller.localStorageEnum().LAT), new esri.SpatialReference({ wkid: 4326 }))

                                controller.map.centerAndZoom(
                                        esri.geometry.geographicToWebMercator(wgsPt),
                                        localStorage.getItem(controller.localStorageEnum().ZOOM_LEVEL)
                                );
                            }
                        }
                        else{
                            controller.map.resize();
                            controller.map.reposition();

                            if(useLocalStore == false){
                                var wgsPt = new esri.geometry.Point(
                                        localStorage.getItem(controller.localStorageEnum().LON),
                                        localStorage.getItem(controller.localStorageEnum().LAT)
                                );
                                //map.width = screen.width;
                                controller.map.centerAndZoom(esri.geometry.geographicToWebMercator(wgsPt), controller.zoomLevel);
                            }
                        }
                    }

                }).bind(this),timeout);
            }
        }
        catch(err){
            console.log("rotateScreen() error " + err.message);
        }

    });

    /**
     * Gets a CSV string compiled from the geolocation service that includes
     * date,lat,lon,accuracy,high_accuracy_boolean,altitude,heading,speed,
     * altitude_accuracy,interval_time,total_elapsed_time
     * @returns {string}
     */
    controller.utils.getAccuracyCSV = (function(){
        return controller._accuracyDataCSV;
    });

    /**
     * Public function for emailing a CSV string containing geolocation service information.
     */
   controller.utils.sendEmail = (function(){
        window.open('mailto:'+ controller._MAIL_TO_ADDRESS +'?subject=HTML5 Accuracy Data&body=' +
                encodeURIComponent(controller.utils.getAccuracyCSV()));
    });

    require(["esri/map","esri/symbols/PictureMarkerSymbol","esri/graphic","esri/geometry/Point","dojo/on"],
            function(Map,PictureMarkerSymbol,Graphic,Point,on) {

                /////
                // PRIVATE Variables
                /////

                controller._on = on;   //event listeners are set by 'on'
                controller._MAIL_TO_ADDRESS = "your_email_address_goes_here";
                controller._supportsLocalStorage = false;
                controller._watchID = null;
                controller._setHighAccuracy = true;
                controller._mostRecentLocation = null;
                controller._accuracyDataCSV = "Date,Lat,Long,Accuracy,High_accuracy_boolean,Altitude,Heading,Speed,Altitude_accuracy,Interval_time,Total_elapsed_time,\r\n";
                controller._pushPinLarge = new esri.symbol.PictureMarkerSymbol("images/pushpin104x108.png", 104, 108);
                controller._pushPinSmall = new esri.symbol.PictureMarkerSymbol("images/pushpin52x54.png", 48, 48);
                controller._locatorMarkerLarge = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_DIAMOND,
                        10,
                        new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0,0,0]), 1),
                        new dojo.Color([255,255,0,0.5]));

                controller._locatorMarkerSmall = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_DIAMOND,
                        5,
                        new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0,0,0]), 1),
                        new dojo.Color([255,255,0,0.5]));
                controller._locatorMarkerGraphicsLayer = new esri.layers.GraphicsLayer();

                controller.init();
            }
    );
</script>
</body>
</html>